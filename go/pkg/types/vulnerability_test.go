// go/pkg/types/vulnerability_test.go
package types

import (
	"encoding/json"
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestVulnerability_ImplementsOutputType(t *testing.T) {
	var _ OutputType = &Vulnerability{}
}

func TestVulnerability_Type(t *testing.T) {
	v := &Vulnerability{}
	assert.Equal(t, "vulnerability", v.Type())
}

func TestVulnerability_ParseFromNuclei(t *testing.T) {
	data, err := os.ReadFile("../../testdata/nuclei_output.json")
	require.NoError(t, err)

	var raw map[string]any
	err = json.Unmarshal(data, &raw)
	require.NoError(t, err)

	vuln, err := VulnerabilityFromMap(raw)
	require.NoError(t, err)

	assert.Equal(t, "HTTP Missing Security Headers", vuln.Name)
	assert.Equal(t, "info", vuln.Severity)
	assert.Equal(t, "https://example.synology.me", vuln.MatchedAt)
	assert.Equal(t, "80.32.101.118", vuln.IP)
	assert.Equal(t, "nuclei", vuln.Provider)
	assert.Equal(t, "http-missing-security-headers", vuln.TemplateID)
	assert.Contains(t, vuln.Tags, "misconfig")
}
