type: workflow
name: host_recon
alias: hostrec
description: Host reconnaissance
long_description: |
  Performs comprehensive reconnaissance on a host or IP address to identify open ports and services.
  Combines multiple port scanning techniques, detects service versions, searches for known vulnerabilities,
  audits SSH configurations, and probes HTTP services. Optionally runs nuclei scans for network and
  SSL vulnerabilities. Essential for understanding a host's security posture and attack surface.
tags: [recon, network, http]
input_types:
  - ip
  - host
  - cidr_range

options:
  nuclei:
    is_flag: True
    default: False
    help: Run nuclei scans (slow)

  scanners:
    type: list
    default: [nmap]
    help: Port scanners to use (naabu, nmap)

  exploiters:
    type: list
    default: [search_vulns]
    help: Exploit providers to use (searchsploit, search_vulns)

  passive:
    is_flag: True
    default: False
    help: Passive only (no requests to targets)
    short: ps

tasks:

  _group:
    naabu:
      description: Find open ports (light)
      if: "'naabu' in opts.scanners and not opts.ports and not opts.passive"

    nmap/light:
      description: Find open ports (light)
      if: "'nmap' in opts.scanners and not opts.ports and not opts.passive"

  nmap:
    description: Detect services and versions
    version_detection: true
    tcp_syn_stealth: false
    fragment: false
    targets_:
    - type: target
      field: name
      condition: opts.ports
    - type: port
      field: host
      condition: opts.scanners
    ports_:
    - type: port
      field: port
      condition: port.host in targets and opts.scanners
    if: not opts.passive

  sshaudit:
    description: Audit SSH port
    targets_:
    - type: port
      field: host
      condition: "port.port == 22 or 'ssh' in port.service_name.lower()"
    if: not opts.passive

  _group/1:
    httpx:
      description: Probe HTTP services on open ports
      tech_detect: True
      targets_:
        - type: port
          field: '{host}:{port}'
      if: not opts.passive

    searchsploit:
      description: Search for related exploits
      targets_:
        - type: port
          field: '{host}:{port}~{service_name}'
          condition: len(item.service_name.split('/')) > 1
      if: "'searchsploit' in opts.exploiters"

    search_vulns:
      description: Search for related exploits
      targets_:
        - type: port
          field: '{host}:{port}~{service_name}'
          condition: len(item.service_name.split('/')) > 1
        - type: vulnerability
          field: '{matched_at}~{id}'
          condition: item.id
      if: "'search_vulns' in opts.exploiters"

  _group/2:
    nuclei/network:
      description: Scan network and SSL vulnerabilities
      tags: [network, ssl]
      if: opts.nuclei and not opts.passive

    nuclei/url:
      description: Search for vulnerabilities on alive HTTP services
      exclude_tags: [network, ssl, file, dns, osint, token-spray, headers]
      targets_:
        - type: url
          field: url
          condition: item.status_code != 0
      if: opts.nuclei and not opts.passive
