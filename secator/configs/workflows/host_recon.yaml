type: workflow
name: host_recon
alias: hostrec
description: Host recon
tags: [recon, network, http]
input_types:
  - ip
  - host
  - cidr_range

options:
  nuclei:
    is_flag: True
    default: False
    help: Run nuclei scans (slow)

  full:
    is_flag: True
    default: False
    help: "Run full port scan (default: top 100 ports)"

tasks:

  _group:
    naabu/light:
      description: Find open ports
      if: opts.ports or not opts.full

    naabu/full:
      description: Find all open ports
      ports: "-"  # scan all ports
      if: opts.full

    nmap/light:
      description: Find open ports
      version_detection: False
      script: null
      if: opts.ports or not opts.full

    nmap/full:
      description: Find open ports
      version_detection: False
      script: null
      ports: "-"  # scan all ports
      if: opts.full

  nmap:
    description: Search for vulnerabilities on open ports
    version_detection: True
    script: vulners
    targets_:
    - port.host
    ports_:
    - type: port
      field: port
      condition: port.host in targets

  sshaudit:
    description: Audit SSH port
    targets_:
    - type: port
      field: host
      condition: "port.port == 22 or 'ssh' in port.service_name.lower()"

  _group/1:
    httpx:
      description: Probe HTTP services on open ports
      tech_detect: True
      targets_:
        - type: port
          field: '{host}:{port}'

    searchsploit:
      description: Search for related exploits
      targets_:
        - type: port
          field: '{host}:{port}~{service_name}'
          condition: len(item.service_name.split('/')) > 1

    search_vulns:
      description: Search for related exploits
      targets_:
        - type: port
          field: '{host}:{port}~{service_name}'
          condition: len(item.service_name.split('/')) > 1
        - type: vulnerability
          field: '{matched_at}~{id}'

  _group/2:
    nuclei/network:
      description: Scan network and SSL vulnerabilities
      tags: [network, ssl]
      exclude_tags: []
      if: opts.nuclei

    nuclei/url:
      description: Search for vulnerabilities on alive HTTP services
      exclude_tags: [network, ssl, file, dns, osint, token-spray, headers]
      targets_:
        - type: url
          field: url
          condition: item.status_code != 0
      if: opts.nuclei
