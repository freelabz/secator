type: workflow
name: subdomain_recon
alias: subrec
description: Subdomain reconnaissance
long_description: |
  Discovers subdomains associated with a target domain using multiple passive and active techniques.
  Combines passive sources, DNS queries, TLS certificate analysis, and optional brute-force methods.
  Verifies discovered subdomains, checks for subdomain takeover vulnerabilities, and can optionally
  test SSL/TLS security or hunt for secrets in HTTP responses. Perfect for mapping attack surface.
tags: [recon, dns, takeovers]
input_types:
  - host

options:
  passive:
    is_flag: True
    help: Passive only (no requests to targets)
    default: False
    short: ps

  active:
    is_flag: True
    help: Active only (no passive sources)
    default: False
    short: active

  brute_http:
    is_flag: True
    help: Bruteforce subdomains with HTTP Host header (ffuf)
    short: bhttp
    default: False

  brute_dns:
    is_flag: True
    help: Bruteforce subdomains with DNS queries (dnsx)
    short: bdns
    default: False

  test_ssl:
    is_flag: True
    help: Test SSL/TLS security on subdomains
    short: tssl
    default: False

  hunt_secrets:
    is_flag: True
    help: Hunt secrets in HTTP responses (trufflehog)
    default: False
    short: hs

tasks:
  httpx/tls:
    description: Find subdomains through TLS certificates
    tech_detect: True
    tls_grab: True
    targets_:
    - target.name
    if: not opts.passive

  _group/hunt:
    subfinder:
      description: List subdomains (passive)
      if: not opts.active

    gau:
      description: List subdomains (passive)
      subs: True
      if: not opts.active

    dnsx/brute:
      description: Bruteforce subdomains (DNS)
      subdomains_only: True
      wordlist: combined_subdomains
      if: opts.brute_dns and not opts.passive

    ffuf:
      description: Bruteforce subdomains (Host header)
      fuzz_host_header: True
      auto_calibration: True
      wordlist: combined_subdomains
      stop_on_error: True
      targets_:
      - type: url
        field: url
        condition: item._source.startswith('httpx')
      if: opts.brute_http and not opts.passive

  _group/probe:
    dnsx/probe:
      description: Verify subdomains by probing DNS records
      subdomains_only: True
      targets_:
      - type: subdomain
        field: host
        condition: not item.verified

    httpx/probe:
      description: Run HTTP probes on subdomains
      tech_detect: True
      targets_:
      - type: subdomain
        field: host
      if: not opts.passive

  _group/vuln:
    testssl:
      description: Test SSL/TLS security on subdomains
      server_defaults: True
      targets_:
      - type: subdomain
        field: host
      if: opts.test_ssl

    nuclei:
      description: Check for subdomain takeovers
      targets_:
      - target.name
      - subdomain.host
      tags: [takeover]
      if: not opts.passive

    trufflehog:
      description: Find secrets in HTTP responses
      targets_:
      - type: url
        field: stored_response_path
        condition: item.stored_response_path != ''
      if: opts.hunt_secrets and not opts.passive
